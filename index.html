<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Accounting Dashboard</title>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Initialize Supabase client
    const supabaseClient = supabase.createClient(
      "https://ehpjupxbworwiepbuxkn.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVocGp1cHhid29yd2llcGJ1eGtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4Mzg5MTQsImV4cCI6MjA2OTQxNDkxNH0.uLGrwVrYn2hk_H5h40H731BvbwIRJPmt_AZTUFbtxH0"
    );

    let deadlineInterval;

    // Google login
    window.signInWithGoogle = async function () {
      try {
        const { error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: "https://za-accounting-dashboard2.vercel.app" }
        });
        if (error) {
          console.error("Google login error:", error);
          alert("Sign-in error: " + error.message);
        }
      } catch (err) {
        console.error("Login failed:", err);
        alert("Login failed. Please try again.");
      }
    };

    // Sign out function
    window.signOut = async function () {
      const { error } = await supabaseClient.auth.signOut();
      if (error) {
        console.error("Sign out error:", error);
        alert("Sign out error: " + error.message);
      } else {
        document.getElementById("loginScreen").classList.remove("hidden");
        document.getElementById("dashboard").classList.add("hidden");
        if (deadlineInterval) clearInterval(deadlineInterval);
      }
    };

    // Check for existing session on page load
    document.addEventListener('DOMContentLoaded', async function() {
      loadCountries(); // Always load countries first
      
      // Restore saved country selection from localStorage
      const savedCountry = localStorage.getItem('selectedCountry');
      const savedCurrency = localStorage.getItem('selectedCurrency');
      
      if (savedCountry && savedCurrency) {
        // Wait for countries to load, then set the selection
        setTimeout(() => {
          const countrySelector = document.getElementById("countrySelector");
          if (countrySelector) {
            countrySelector.value = savedCountry;
            window.selectedCurrency = savedCurrency;
            updateCurrencyDisplay(savedCurrency);
            loadDeadlines(savedCountry);
            console.log("Restored country:", savedCountry, "Currency:", savedCurrency);
          }
        }, 500);
      }
      
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        showDashboard(session.user);
      }
    });

    // Listen for login state changes
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        showDashboard(session.user);
      } else if (event === 'SIGNED_OUT') {
        showLoginScreen();
      }
    });

    function showDashboard(user) {
      document.getElementById("userName").textContent = user.user_metadata?.name || user.email;
      document.getElementById("userAvatar").src = user.user_metadata?.avatar_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23e5e7eb"/><text x="50" y="55" text-anchor="middle" font-size="40" fill="%236b7280">üë§</text></svg>';
      document.getElementById("loginScreen").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      
      // Restore currency settings after login
      const savedCountry = localStorage.getItem('selectedCountry');
      const savedCurrency = localStorage.getItem('selectedCurrency');
      
      if (savedCountry && savedCurrency) {
        window.selectedCurrency = savedCurrency;
        updateCurrencyDisplay(savedCurrency);
        console.log("Currency restored after login:", savedCurrency);
      }
      
      loadBusinessProfile();
      startDeadlineCountdown();
    }

    function showLoginScreen() {
      document.getElementById("loginScreen").classList.remove("hidden");
      document.getElementById("dashboard").classList.add("hidden");
      if (deadlineInterval) clearInterval(deadlineInterval);
    }

    // Load countries from Supabase or use fallback
    async function loadCountries() {
      try {
        const { data, error } = await supabaseClient.from('countries').select('*');
        const selector = document.getElementById("countrySelector");
        selector.innerHTML = '<option value="">-- Select Country --</option>';
        
        if (error || !data || data.length === 0) {
          console.log("Using fallback countries list");
          // Fallback countries list
          const fallbackCountries = [
            { code: 'US', name: 'United States', currency: 'USD' },
            { code: 'CA', name: 'Canada', currency: 'CAD' },
            { code: 'GB', name: 'United Kingdom', currency: 'GBP' },
            { code: 'AU', name: 'Australia', currency: 'AUD' },
            { code: 'ZA', name: 'South Africa', currency: 'ZAR' },
            { code: 'DE', name: 'Germany', currency: 'EUR' },
            { code: 'FR', name: 'France', currency: 'EUR' },
            { code: 'JP', name: 'Japan', currency: 'JPY' },
            { code: 'IN', name: 'India', currency: 'INR' },
            { code: 'BR', name: 'Brazil', currency: 'BRL' }
          ];
          
          fallbackCountries.forEach(c => {
            const option = document.createElement("option");
            option.value = c.code;
            option.textContent = `${c.name} (${c.currency})`;
            selector.appendChild(option);
          });
        } else {
          data.forEach(c => {
            const option = document.createElement("option");
            option.value = c.code;
            option.textContent = `${c.name} (${c.currency})`;
            selector.appendChild(option);
          });
        }
      } catch (err) {
        console.error("Failed to load countries:", err);
        // Show error message to user
        const selector = document.getElementById("countrySelector");
        selector.innerHTML = '<option value="">Error loading countries - please refresh</option>';
      }
    }

    // Save country selection
    window.setUserCountry = async function() {
      const countryCode = document.getElementById("countrySelector").value;
      if (!countryCode) return;
      
      console.log("Selected country:", countryCode);
      
      // Get currency for selected country
      const selectedOption = document.getElementById("countrySelector").selectedOptions[0];
      const currencyMatch = selectedOption.textContent.match(/\(([^)]+)\)/);
      const currency = currencyMatch ? currencyMatch[1] : 'USD';
      
      // Store in localStorage for persistence across login
      localStorage.setItem('selectedCountry', countryCode);
      localStorage.setItem('selectedCurrency', currency);
      
      // Update currency display
      updateCurrencyDisplay(currency);
      
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
          const { error } = await supabaseClient.from("profiles").upsert({
            id: user.id,
            country_code: countryCode,
            currency: currency
          });
          if (error) console.error("Error saving country:", error);
        }
        
        // Always load deadlines regardless of user login status
        loadDeadlines(countryCode);
      } catch (err) {
        console.error("Error in setUserCountry:", err);
        // Still try to load deadlines
        loadDeadlines(countryCode);
      }
    }
    
    // Update currency display throughout the app
    function updateCurrencyDisplay(currency) {
      // Store currency globally for use in AI results
      window.selectedCurrency = currency;
      
      // Update any existing currency displays
      const currencyElements = document.querySelectorAll('.currency-symbol');
      currencyElements.forEach(el => {
        el.textContent = getCurrencySymbol(currency);
      });
      
      // Force refresh of deadlines to show new currency
      const countryCode = document.getElementById("countrySelector").value;
      if (countryCode) {
        loadDeadlines(countryCode);
      }
      
      // Update any existing results with new currency
      updateExistingResultsCurrency(currency);
    }
    
    // Update existing results with new currency
    function updateExistingResultsCurrency(currency) {
      const currencySymbol = getCurrencySymbol(currency);
      
      // Update AI results if they exist
      const aiResults = document.getElementById('aiResults');
      if (aiResults && aiResults.innerHTML.includes('$') || aiResults.innerHTML.includes('¬£') || aiResults.innerHTML.includes('‚Ç¨')) {
        // Re-process to show correct currency
        console.log('Currency changed - results will update on next processing');
      }
      
      // Update receipt results if they exist
      const receiptResults = document.getElementById('receiptResults');
      if (receiptResults && receiptResults.innerHTML.includes('$') || receiptResults.innerHTML.includes('¬£') || receiptResults.innerHTML.includes('‚Ç¨')) {
        console.log('Currency changed - receipt results will update on next scan');
      }
      
      // Update report results if they exist
      const reportsResults = document.getElementById('reportsResults');
      if (reportsResults && reportsResults.innerHTML.includes('$') || reportsResults.innerHTML.includes('¬£') || reportsResults.innerHTML.includes('‚Ç¨')) {
        console.log('Currency changed - reports will update on next generation');
      }
    }
    
    // Get currency symbol
    function getCurrencySymbol(currency) {
      const symbols = {
        'USD': '$', 'CAD': 'C$', 'GBP': '¬£', 'EUR': '‚Ç¨', 
        'AUD': 'A$', 'ZAR': 'R', 'JPY': '¬•', 'INR': '‚Çπ', 'BRL': 'R$'
      };
      return symbols[currency] || '$';
    }

    // Load deadlines with live countdowns
    async function loadDeadlines(countryCode) {
      try {
        const { data, error } = await supabaseClient
          .from("tax_deadlines")
          .select("*")
          .eq("country_code", countryCode);
        
        const container = document.getElementById("deadlineReminders");
        container.innerHTML = "";
        
        let deadlines = [];
        
        if (error || !data || data.length === 0) {
          console.log("Using sample deadlines for", countryCode);
          // Sample deadlines based on country
          const sampleDeadlines = {
            'US': [
              { id: 1, deadline_type: 'Individual Tax Return', deadline_date: '2024-04-15' },
              { id: 2, deadline_type: 'Quarterly Estimated Tax', deadline_date: '2024-06-15' }
            ],
            'CA': [
              { id: 3, deadline_type: 'Individual Tax Return', deadline_date: '2024-04-30' },
              { id: 4, deadline_type: 'Corporate Tax Return', deadline_date: '2024-06-30' }
            ],
            'GB': [
              { id: 5, deadline_type: 'Self Assessment', deadline_date: '2024-01-31' },
              { id: 6, deadline_type: 'Corporation Tax', deadline_date: '2024-12-31' }
            ],
            'AU': [
              { id: 7, deadline_type: 'Individual Tax Return', deadline_date: '2024-10-31' },
              { id: 8, deadline_type: 'BAS Statement', deadline_date: '2024-07-28' }
            ],
            'ZA': [
              { id: 9, deadline_type: 'Individual Tax Return', deadline_date: '2024-11-30' },
              { id: 10, deadline_type: 'Provisional Tax', deadline_date: '2024-08-31' }
            ]
          };
          
          deadlines = sampleDeadlines[countryCode] || [
            { id: 99, deadline_type: 'Tax Return', deadline_date: '2024-12-31' }
          ];
        } else {
          deadlines = data;
        }

        deadlines.forEach(deadline => {
          const div = document.createElement("div");
          div.className = "bg-gradient-to-r from-red-500 to-orange-500 text-white p-4 rounded-xl mb-3 shadow-lg";
          div.id = `deadline-${deadline.id}`;
          container.appendChild(div);
        });
        
        updateDeadlineCountdowns(deadlines);
        
        // Clear existing interval and start new one
        if (deadlineInterval) clearInterval(deadlineInterval);
        deadlineInterval = setInterval(() => updateDeadlineCountdowns(deadlines), 60000);
        
      } catch (err) {
        console.error("Failed to load deadlines:", err);
        const container = document.getElementById("deadlineReminders");
        container.innerHTML = '<div class="text-red-500 text-center py-4">Error loading deadlines - please try again</div>';
      }
    }

    // Update deadline countdowns with tax calculations
    function updateDeadlineCountdowns(deadlines) {
      deadlines.forEach(deadline => {
        const deadlineDate = new Date(deadline.deadline_date);
        const now = new Date();
        const timeDiff = deadlineDate - now;
        
        const div = document.getElementById(`deadline-${deadline.id}`);
        if (!div) return;
        
        // Calculate estimated tax amounts based on current data
        const currency = window.selectedCurrency || 'USD';
        const currencySymbol = getCurrencySymbol(currency);
        const estimatedIncome = 45000; // Mock calculation
        const estimatedTax = calculateTaxByCountry(estimatedIncome, currency);
        const estimatedRefund = Math.random() > 0.5 ? Math.floor(Math.random() * 2000) : 0;
        
        if (timeDiff <= 0) {
          div.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-bold text-lg">${deadline.deadline_type.toUpperCase()} TAX DEADLINE</h3>
                <p class="text-red-200">‚ö†Ô∏è OVERDUE - ${deadlineDate.toDateString()}</p>
                <p class="text-red-100 text-sm">Estimated Tax: ${currencySymbol}${estimatedTax.toLocaleString()}</p>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold">OVERDUE</div>
              </div>
            </div>
          `;
        } else {
          const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
          const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
          
          div.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-bold text-lg">${deadline.deadline_type.toUpperCase()} TAX DEADLINE</h3>
                <p class="text-orange-100">${deadlineDate.toDateString()}</p>
                <div class="text-orange-100 text-sm mt-1">
                  ${estimatedRefund > 0 ? 
                    `üí∞ Expected Refund: ${currencySymbol}${estimatedRefund.toLocaleString()}` : 
                    `üí∏ Estimated Tax Due: ${currencySymbol}${estimatedTax.toLocaleString()}`
                  }
                </div>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold">${days}d ${hours}h ${minutes}m</div>
                <div class="text-sm text-orange-200">remaining</div>
              </div>
            </div>
          `;
        }
      });
    }
    
    // Calculate tax by country
    function calculateTaxByCountry(income, currency) {
      const taxRates = {
        'USD': 0.22, // US average
        'CAD': 0.26, // Canada average
        'GBP': 0.20, // UK basic rate
        'EUR': 0.25, // EU average
        'AUD': 0.19, // Australia
        'ZAR': 0.18, // South Africa
        'JPY': 0.15, // Japan
        'INR': 0.20, // India
        'BRL': 0.27  // Brazil
      };
      
      const rate = taxRates[currency] || 0.20;
      return Math.floor(income * rate);
    }
    
    // Apply country-specific tax rules
    function applyCountryTaxRules(transactions, countryCode, currency) {
      const taxRules = {
        'US': {
          mealDeductionRate: 0.50, // 50% deductible
          homeOfficeAllowed: true,
          vehicleDeductionMethod: 'mileage', // or 'actual'
          softwareFullyDeductible: true
        },
        'CA': {
          mealDeductionRate: 0.50,
          homeOfficeAllowed: true,
          vehicleDeductionMethod: 'actual',
          softwareFullyDeductible: true,
          gstHstRequired: true
        },
        'GB': {
          mealDeductionRate: 1.00, // 100% if business purpose
          homeOfficeAllowed: true,
          vehicleDeductionMethod: 'mileage',
          softwareFullyDeductible: true,
          vatRequired: true
        },
        'AU': {
          mealDeductionRate: 1.00,
          homeOfficeAllowed: true,
          vehicleDeductionMethod: 'logbook',
          softwareFullyDeductible: true,
          gstRequired: true
        },
        'ZA': {
          mealDeductionRate: 1.00,
          homeOfficeAllowed: true,
          vehicleDeductionMethod: 'actual',
          softwareFullyDeductible: true,
          vatRequired: true
        }
      };
      
      const rules = taxRules[countryCode] || taxRules['US']; // Default to US rules
      
      return transactions.map(transaction => {
        let updatedTransaction = { ...transaction };
        
        // Apply meal deduction rules
        if (transaction.category === 'Meals & Entertainment' && transaction.deductible) {
          if (rules.mealDeductionRate < 1.0) {
            updatedTransaction.amount = transaction.amount * rules.mealDeductionRate;
            updatedTransaction.tax_rule = `${countryCode}: ${rules.mealDeductionRate * 100}% meal deduction applied`;
          } else {
            updatedTransaction.tax_rule = `${countryCode}: Full meal deduction (business purpose)`;
          }
        }
        
        // Apply software deduction rules
        if (transaction.category === 'Software/Technology' && rules.softwareFullyDeductible) {
          updatedTransaction.tax_rule = `${countryCode}: Software fully deductible`;
        }
        
        // Apply vehicle expense rules
        if (transaction.category === 'Vehicle Expenses') {
          updatedTransaction.tax_rule = `${countryCode}: Vehicle expenses (${rules.vehicleDeductionMethod} method)`;
        }
        
        // Add VAT/GST notes
        if (rules.vatRequired || rules.gstRequired || rules.gstHstRequired) {
          const taxType = rules.vatRequired ? 'VAT' : rules.gstHstRequired ? 'GST/HST' : 'GST';
          updatedTransaction.tax_rule = (updatedTransaction.tax_rule || '') + ` - ${taxType} applicable`;
        }
        
        return updatedTransaction;
      });
    }

    // Start deadline countdown timer
    async function startDeadlineCountdown() {
      const user = (await supabaseClient.auth.getUser()).data.user;
      if (!user) return;
      
      const { data: profile } = await supabaseClient
        .from("profiles")
        .select("country_code")
        .eq("id", user.id)
        .single();
      
      if (profile?.country_code) {
        const { data: deadlines } = await supabaseClient
          .from("tax_deadlines")
          .select("*")
          .eq("country_code", profile.country_code);
        
        if (deadlines) {
          updateDeadlineCountdowns(deadlines);
          deadlineInterval = setInterval(() => updateDeadlineCountdowns(deadlines), 60000); // Update every minute
        }
      }
    }

    // Save business profile
    window.saveBusinessProfile = async function() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
          alert("Please sign in first");
          return;
        }
        
        const businessName = document.getElementById("businessName").value;
        const taxNumber = document.getElementById("taxNumber").value;
        const businessType = document.getElementById("businessType").value;
        const prefersPersonal = document.getElementById("prefersPersonal").checked;
        const prefersBusiness = document.getElementById("prefersBusiness").checked;
        
        const { error } = await supabaseClient.from("profiles").upsert({
          id: user.id,
          business_name: businessName,
          tax_number: taxNumber,
          business_type: businessType,
          prefers_personal: prefersPersonal,
          prefers_business: prefersBusiness
        });
        
        if (error) {
          console.error("Error saving profile:", error);
          alert("Error saving profile: " + error.message);
        } else {
          document.getElementById("profileSavedMsg").classList.remove("hidden");
          setTimeout(() => document.getElementById("profileSavedMsg").classList.add("hidden"), 3000);
        }
      } catch (err) {
        console.error("Error in saveBusinessProfile:", err);
        alert("Error saving profile. Please try again.");
      }
    }

    // Load business profile
    async function loadBusinessProfile() {
      const user = (await supabaseClient.auth.getUser()).data.user;
      if (!user) return;
      const { data, error } = await supabaseClient
        .from("profiles")
        .select("business_name, tax_number, business_type, prefers_personal, prefers_business")
        .eq("id", user.id)
        .single();
      if (!error && data) {
        document.getElementById("businessName").value = data.business_name || "";
        document.getElementById("taxNumber").value = data.tax_number || "";
        document.getElementById("businessType").value = data.business_type || "";
        document.getElementById("prefersPersonal").checked = data.prefers_personal || false;
        document.getElementById("prefersBusiness").checked = data.prefers_business || false;
      }
    }

    // Demo mode for testing
    window.enterDemoMode = function() {
      const demoUser = {
        email: 'demo@example.com',
        user_metadata: {
          name: 'Demo User',
          avatar_url: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%234f46e5"/><text x="50" y="55" text-anchor="middle" font-size="40" fill="white">üë§</text></svg>'
        }
      };
      showDashboard(demoUser);
    };

    // Smart Receipt Scanner
    window.scanReceipts = async function() {
      const fileInput = document.getElementById('receiptPhotos');
      const files = fileInput.files;
      
      if (files.length === 0) {
        alert('Please select receipt photos first');
        return;
      }
      
      const resultsDiv = document.getElementById('receiptResults');
      resultsDiv.innerHTML = '<div class="text-purple-600"><i class="fas fa-spinner fa-spin mr-2"></i>AI is scanning your receipts...</div>';
      
      // Simulate AI receipt processing
      setTimeout(async () => {
        const currency = localStorage.getItem('selectedCurrency') || window.selectedCurrency || 'USD';
        const currencySymbol = getCurrencySymbol(currency);
        console.log("Processing receipts with currency:", currency);
        
        // Get receipt amounts based on selected currency
        const receiptAmounts = {
          'USD': { office: 127.45, gas: 65.30, coffee: 12.50 },
          'GBP': { office: 101.25, gas: 51.85, coffee: 9.95 },
          'EUR': { office: 117.30, gas: 60.15, coffee: 11.50 },
          'CAD': { office: 172.05, gas: 88.20, coffee: 16.88 },
          'AUD': { office: 192.25, gas: 98.55, coffee: 18.85 },
          'ZAR': { office: 2386.75, gas: 1222.30, coffee: 233.75 },
          'JPY': { office: 19118, gas: 9795, coffee: 1875 },
          'INR': { office: 10621, gas: 5441, coffee: 1041 },
          'BRL': { office: 638.25, gas: 326.50, coffee: 62.50 }
        };
        
        const amounts = receiptAmounts[currency] || receiptAmounts['USD'];
        
        const mockReceiptData = [
          { 
            vendor: 'Office Depot', 
            date: '2024-01-20', 
            amount: amounts.office, 
            items: ['Paper (5 reams)', 'Pens (12 pack)', 'Stapler'], 
            category: 'Office Supplies',
            deductible: true 
          },
          { 
            vendor: 'Shell Gas Station', 
            date: '2024-01-22', 
            amount: amounts.gas, 
            items: ['Gasoline'], 
            category: 'Vehicle Expenses',
            deductible: true 
          },
          { 
            vendor: 'Starbucks', 
            date: '2024-01-23', 
            amount: amounts.coffee, 
            items: ['Coffee', 'Muffin'], 
            category: 'Meals & Entertainment',
            deductible: true 
          }
        ];
        
        // Store receipt data in database if user is logged in
        try {
          const { data: { user } } = await supabaseClient.auth.getUser();
          if (user) {
            for (const receipt of mockReceiptData) {
              await supabaseClient.from('transactions').insert({
                user_id: user.id,
                date: receipt.date,
                description: `${receipt.vendor} - ${receipt.items.join(', ')}`,
                amount: -receipt.amount, // Expenses are negative
                category: receipt.category,
                deductible: receipt.deductible,
                currency: currency,
                source: 'receipt_scan',
                created_at: new Date().toISOString()
              });
            }
          }
        } catch (error) {
          console.log('Note: Receipt data not saved to database (demo mode)');
        }
        
        let html = '<div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4"><h3 class="text-purple-800 font-bold mb-2"><i class="fas fa-check-circle mr-2"></i>Receipt Scanning Complete!</h3><p class="text-purple-700">Successfully processed ' + mockReceiptData.length + ' receipts</p></div>';
        
        mockReceiptData.forEach((receipt, index) => {
          html += `<div class="bg-white border border-gray-200 rounded-lg p-4 mb-4 shadow-sm">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h4 class="font-bold text-lg text-gray-800">${receipt.vendor}</h4>
                <p class="text-gray-600">${receipt.date}</p>
              </div>
              <div class="text-right">
                <div class="text-xl font-bold text-red-600">-${currencySymbol}${receipt.amount.toFixed(2)}</div>
                <span class="bg-green-500 text-white px-2 py-1 rounded text-xs">‚úì Deductible</span>
              </div>
            </div>
            <div class="mb-2">
              <strong>Items:</strong> ${receipt.items.join(', ')}
            </div>
            <div class="mb-2">
              <strong>Category:</strong> <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">${receipt.category}</span>
            </div>
          </div>`;
        });
        
        const totalAmount = mockReceiptData.reduce((sum, receipt) => sum + receipt.amount, 0);
        html += `<div class="mt-4 p-4 bg-green-50 rounded-lg">
          <h4 class="font-bold text-green-800 mb-2">Receipt Summary</h4>
          <p class="text-green-700">Total Expenses Scanned: ${currencySymbol}${totalAmount.toFixed(2)}</p>
          <p class="text-green-700">All items categorized as tax-deductible business expenses</p>
        </div>`;
        
        resultsDiv.innerHTML = html;
      }, 2500);
    };

    // Generate Monthly Report
    window.generateMonthlyReport = async function() {
      const resultsDiv = document.getElementById('reportsResults');
      resultsDiv.innerHTML = '<div class="text-green-600"><i class="fas fa-spinner fa-spin mr-2"></i>Generating your monthly P&L report...</div>';
      
      setTimeout(() => {
        const currency = localStorage.getItem('selectedCurrency') || window.selectedCurrency || 'USD';
        const currencySymbol = getCurrencySymbol(currency);
        const currentMonth = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
        console.log("Generating report with currency:", currency);
        
        // Get report amounts based on selected currency
        const reportAmounts = {
          'USD': { clientPayments: 8500, consultingFees: 2200, office: 245.50, software: 299.97, vehicle: 180.30, meals: 125.80 },
          'GBP': { clientPayments: 6750, consultingFees: 1750, office: 195.40, software: 238.50, vehicle: 143.25, meals: 100.00 },
          'EUR': { clientPayments: 7820, consultingFees: 2025, office: 225.30, software: 276.00, vehicle: 166.00, meals: 115.80 },
          'CAD': { clientPayments: 11475, consultingFees: 2970, office: 330.15, software: 404.96, vehicle: 243.41, meals: 169.83 },
          'AUD': { clientPayments: 12835, consultingFees: 3322, office: 370.25, software: 452.96, vehicle: 272.05, meals: 189.71 },
          'ZAR': { clientPayments: 159250, consultingFees: 41200, office: 4590.50, software: 5614.53, vehicle: 3375.61, meals: 2353.00 },
          'JPY': { clientPayments: 1275000, consultingFees: 330000, office: 36750, software: 44996, vehicle: 27045, meals: 18870 },
          'INR': { clientPayments: 708750, consultingFees: 183400, office: 20415, software: 24997, vehicle: 15025, meals: 10483 },
          'BRL': { clientPayments: 42500, consultingFees: 11000, office: 1227.50, software: 1499.85, vehicle: 901.50, meals: 628.90 }
        };
        
        const amounts = reportAmounts[currency] || reportAmounts['USD'];
        const totalIncome = amounts.clientPayments + amounts.consultingFees;
        const totalExpenses = amounts.office + amounts.software + amounts.vehicle + amounts.meals;
        const netProfit = totalIncome - totalExpenses;
        
        let html = `<div class="bg-white border border-gray-200 rounded-lg p-6 shadow-lg">
          <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Profit & Loss Statement</h3>
            <p class="text-gray-600">${currentMonth}</p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="font-bold text-green-800 mb-3 text-lg">üìà INCOME</h4>
              <div class="space-y-2">
                <div class="flex justify-between"><span>Client Payments</span><span class="font-bold text-green-600">+${currencySymbol}${amounts.clientPayments.toLocaleString()}</span></div>
                <div class="flex justify-between"><span>Consulting Fees</span><span class="font-bold text-green-600">+${currencySymbol}${amounts.consultingFees.toLocaleString()}</span></div>
                <div class="border-t pt-2 flex justify-between font-bold text-lg">
                  <span>Total Income</span><span class="text-green-600">+${currencySymbol}${totalIncome.toLocaleString()}</span>
                </div>
              </div>
            </div>
            
            <div>
              <h4 class="font-bold text-red-800 mb-3 text-lg">üìâ EXPENSES</h4>
              <div class="space-y-2">
                <div class="flex justify-between"><span>Office Supplies</span><span class="text-red-600">-${currencySymbol}${amounts.office.toFixed(2)}</span></div>
                <div class="flex justify-between"><span>Software Subscriptions</span><span class="text-red-600">-${currencySymbol}${amounts.software.toFixed(2)}</span></div>
                <div class="flex justify-between"><span>Vehicle Expenses</span><span class="text-red-600">-${currencySymbol}${amounts.vehicle.toFixed(2)}</span></div>
                <div class="flex justify-between"><span>Meals & Entertainment</span><span class="text-red-600">-${currencySymbol}${amounts.meals.toFixed(2)}</span></div>
                <div class="border-t pt-2 flex justify-between font-bold text-lg">
                  <span>Total Expenses</span><span class="text-red-600">-${currencySymbol}${totalExpenses.toFixed(2)}</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-6 p-4 bg-blue-50 rounded-lg">
            <div class="flex justify-between items-center">
              <span class="text-xl font-bold text-gray-800">NET PROFIT</span>
              <span class="text-2xl font-bold text-blue-600">${currencySymbol}${netProfit.toLocaleString()}</span>
            </div>
            <p class="text-sm text-gray-600 mt-2">Profit Margin: ${((netProfit / totalIncome) * 100).toFixed(1)}%</p>
          </div>
          
          <div class="mt-4 flex space-x-3">
            <button onclick="exportReportPDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
              <i class="fas fa-file-pdf mr-2"></i>Export PDF
            </button>
            <button onclick="exportReportCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
              <i class="fas fa-file-csv mr-2"></i>Export CSV
            </button>
          </div>
        </div>`;
        
        resultsDiv.innerHTML = html;
      }, 1500);
    };

    // Get Business Insights
    window.getBusinessInsights = async function() {
      const resultsDiv = document.getElementById('reportsResults');
      resultsDiv.innerHTML = '<div class="text-orange-600"><i class="fas fa-spinner fa-spin mr-2"></i>AI is analyzing your business data...</div>';
      
      setTimeout(() => {
        const currency = window.selectedCurrency || 'USD';
        const currencySymbol = getCurrencySymbol(currency);
        
        let html = `<div class="space-y-4">
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
            <h3 class="font-bold text-orange-800 mb-3"><i class="fas fa-lightbulb mr-2"></i>AI Business Insights</h3>
            
            <div class="space-y-4">
              <div class="bg-white p-4 rounded-lg border-l-4 border-red-500">
                <h4 class="font-bold text-red-700 mb-2">‚ö†Ô∏è Overspending Alert</h4>
                <p class="text-gray-700">You spent 40% more on office supplies this month (${currencySymbol}245 vs ${currencySymbol}175 average). Consider bulk purchasing to save money.</p>
              </div>
              
              <div class="bg-white p-4 rounded-lg border-l-4 border-green-500">
                <h4 class="font-bold text-green-700 mb-2">üí° Tax Deduction Opportunity</h4>
                <p class="text-gray-700">You can deduct home office expenses! Based on your business use, you could save approximately ${currencySymbol}1,200 annually.</p>
              </div>
              
              <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500">
                <h4 class="font-bold text-blue-700 mb-2">üìä Profit Trend</h4>
                <p class="text-gray-700">Your profit margin improved by 8% this month. Your cost control on software subscriptions is paying off!</p>
              </div>
              
              <div class="bg-white p-4 rounded-lg border-l-4 border-purple-500">
                <h4 class="font-bold text-purple-700 mb-2">üéØ Recommendation</h4>
                <p class="text-gray-700">Consider setting up a business savings account. You could save ${currencySymbol}500/month based on your current profit levels.</p>
              </div>
            </div>
            
            <div class="mt-4 p-3 bg-yellow-50 rounded-lg">
              <p class="text-sm text-yellow-800"><strong>Next Steps:</strong> Review your office supply vendors, set up home office deduction tracking, and consider quarterly tax payments.</p>
            </div>
          </div>
        </div>`;
        
        resultsDiv.innerHTML = html;
      }, 2000);
    };

    // Show Budget Tracker
    window.showBudgetTracker = async function() {
      const resultsDiv = document.getElementById('reportsResults');
      resultsDiv.innerHTML = '<div class="text-indigo-600"><i class="fas fa-spinner fa-spin mr-2"></i>Loading your budget tracker...</div>';
      
      setTimeout(() => {
        const currency = window.selectedCurrency || 'USD';
        const currencySymbol = getCurrencySymbol(currency);
        
        // Get budget amounts based on selected currency
        const budgetAmounts = {
          'USD': { officeSpent: 245, officeBudget: 200, softwareSpent: 300, softwareBudget: 400, vehicleSpent: 180, vehicleBudget: 250, mealsSpent: 126, mealsBudget: 150 },
          'GBP': { officeSpent: 195, officeBudget: 159, softwareSpent: 238, softwareBudget: 318, vehicleSpent: 143, vehicleBudget: 199, mealsSpent: 100, mealsBudget: 119 },
          'EUR': { officeSpent: 225, officeBudget: 184, softwareSpent: 276, softwareBudget: 368, vehicleSpent: 166, vehicleBudget: 230, mealsSpent: 116, mealsBudget: 138 },
          'CAD': { officeSpent: 330, officeBudget: 270, softwareSpent: 405, softwareBudget: 540, vehicleSpent: 243, vehicleBudget: 338, mealsSpent: 170, mealsBudget: 203 },
          'AUD': { officeSpent: 370, officeBudget: 302, softwareSpent: 453, softwareBudget: 604, vehicleSpent: 272, vehicleBudget: 378, mealsSpent: 190, mealsBudget: 227 },
          'ZAR': { officeSpent: 4591, officeBudget: 3750, softwareSpent: 5615, softwareBudget: 7487, vehicleSpent: 3376, vehicleBudget: 4688, mealsSpent: 2353, mealsBudget: 2813 },
          'JPY': { officeSpent: 36750, officeBudget: 30000, softwareSpent: 44996, softwareBudget: 59995, vehicleSpent: 27045, vehicleBudget: 37500, mealsSpent: 18870, mealsBudget: 22500 },
          'INR': { officeSpent: 20415, officeBudget: 16667, softwareSpent: 24997, softwareBudget: 33329, vehicleSpent: 15025, vehicleBudget: 20833, mealsSpent: 10483, mealsBudget: 12500 },
          'BRL': { officeSpent: 1228, officeBudget: 1003, softwareSpent: 1500, softwareBudget: 2000, vehicleSpent: 902, vehicleBudget: 1252, mealsSpent: 629, mealsBudget: 751 }
        };
        
        const amounts = budgetAmounts[currency] || budgetAmounts['USD'];
        const totalBudget = amounts.officeBudget + amounts.softwareBudget + amounts.vehicleBudget + amounts.mealsBudget;
        const totalSpent = amounts.officeSpent + amounts.softwareSpent + amounts.vehicleSpent + amounts.mealsSpent;
        const remaining = totalBudget - totalSpent;
        const overBudget = amounts.officeSpent - amounts.officeBudget;
        
        let html = `<div class="bg-white border border-gray-200 rounded-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-piggy-bank mr-2 text-indigo-500"></i>Monthly Budget Tracker</h3>
          
          <div class="space-y-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="font-medium">Office Supplies</span>
                <span class="text-sm text-gray-600">${currencySymbol}${amounts.officeSpent} / ${currencySymbol}${amounts.officeBudget}</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="bg-red-500 h-3 rounded-full" style="width: ${Math.min((amounts.officeSpent / amounts.officeBudget) * 100, 100)}%"></div>
              </div>
              <p class="text-xs text-red-600 mt-1">‚ö†Ô∏è Over budget by ${currencySymbol}${overBudget}</p>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="font-medium">Software & Tools</span>
                <span class="text-sm text-gray-600">${currencySymbol}${amounts.softwareSpent} / ${currencySymbol}${amounts.softwareBudget}</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="bg-green-500 h-3 rounded-full" style="width: ${(amounts.softwareSpent / amounts.softwareBudget) * 100}%"></div>
              </div>
              <p class="text-xs text-green-600 mt-1">‚úì ${currencySymbol}${amounts.softwareBudget - amounts.softwareSpent} remaining</p>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="font-medium">Vehicle Expenses</span>
                <span class="text-sm text-gray-600">${currencySymbol}${amounts.vehicleSpent} / ${currencySymbol}${amounts.vehicleBudget}</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="bg-blue-500 h-3 rounded-full" style="width: ${(amounts.vehicleSpent / amounts.vehicleBudget) * 100}%"></div>
              </div>
              <p class="text-xs text-blue-600 mt-1">‚úì ${currencySymbol}${amounts.vehicleBudget - amounts.vehicleSpent} remaining</p>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="font-medium">Meals & Entertainment</span>
                <span class="text-sm text-gray-600">${currencySymbol}${amounts.mealsSpent} / ${currencySymbol}${amounts.mealsBudget}</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="bg-yellow-500 h-3 rounded-full" style="width: ${(amounts.mealsSpent / amounts.mealsBudget) * 100}%"></div>
              </div>
              <p class="text-xs text-yellow-600 mt-1">‚ö†Ô∏è ${currencySymbol}${amounts.mealsBudget - amounts.mealsSpent} remaining</p>
            </div>
          </div>
          
          <div class="mt-6 p-4 bg-indigo-50 rounded-lg">
            <h4 class="font-bold text-indigo-800 mb-2">Budget Summary</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div><span class="text-gray-600">Total Budget:</span> <span class="font-bold">${currencySymbol}${totalBudget.toLocaleString()}</span></div>
              <div><span class="text-gray-600">Total Spent:</span> <span class="font-bold">${currencySymbol}${totalSpent.toLocaleString()}</span></div>
              <div><span class="text-gray-600">Remaining:</span> <span class="font-bold text-green-600">${currencySymbol}${Math.max(remaining, 0).toLocaleString()}</span></div>
              <div><span class="text-gray-600">Over Budget:</span> <span class="font-bold text-red-600">${currencySymbol}${Math.max(overBudget, 0)}</span></div>
            </div>
          </div>
          
          <div class="mt-4">
            <button onclick="setBudgets()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
              <i class="fas fa-edit mr-2"></i>Edit Budgets
            </button>
          </div>
        </div>`;
        
        resultsDiv.innerHTML = html;
      }, 1000);
    };

    // AI Bank Statement Processing
    window.processStatements = async function() {
      const fileInput = document.getElementById('bankStatements');
      const files = fileInput.files;
      
      if (files.length === 0) {
        alert('Please select bank statement files first');
        return;
      }
      
      const resultsDiv = document.getElementById('aiResults');
      resultsDiv.innerHTML = '<div class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>AI is processing your statements...</div>';
      
      // Simulate AI processing
      setTimeout(async () => {
        // Get currency from localStorage first, then fallback to window variable
        const currency = localStorage.getItem('selectedCurrency') || window.selectedCurrency || 'USD';
        const currencySymbol = getCurrencySymbol(currency);
        console.log("Processing bank statements with currency:", currency);
        
        // Get currency amounts based on selected country
        const baseAmounts = {
          'USD': { office: 245.50, income: 2500.00, meal: 85.30, software: 99.99, personal: 156.78 },
          'GBP': { office: 195.40, income: 1980.00, meal: 67.85, software: 79.50, personal: 124.60 },
          'EUR': { office: 225.30, income: 2300.00, meal: 78.40, software: 92.00, personal: 144.20 },
          'CAD': { office: 330.15, income: 3375.00, meal: 115.15, software: 134.99, personal: 211.55 },
          'AUD': { office: 370.25, income: 3775.00, meal: 128.95, software: 150.99, personal: 236.67 },
          'ZAR': { office: 4590.50, income: 46750.00, meal: 1596.30, software: 1869.99, personal: 2934.78 },
          'JPY': { office: 36750, income: 374500, meal: 12795, software: 14999, personal: 23517 },
          'INR': { office: 20415, income: 208250, meal: 7107, software: 8324, personal: 13064 },
          'BRL': { office: 1227.50, income: 12500.00, meal: 426.50, software: 499.95, personal: 783.90 }
        };
        
        const amounts = baseAmounts[currency] || baseAmounts['USD'];
        
        const mockResults = [
          { date: '2024-01-15', description: 'Office Supplies Store', amount: -amounts.office, category: 'Office Expenses', deductible: true },
          { date: '2024-01-18', description: 'Client Payment - ABC Corp', amount: amounts.income, category: 'Business Income', deductible: false },
          { date: '2024-01-22', description: 'Business Lunch - Restaurant', amount: -amounts.meal, category: 'Meals & Entertainment', deductible: true },
          { date: '2024-01-25', description: 'Software Subscription', amount: -amounts.software, category: 'Software/Technology', deductible: true },
          { date: '2024-01-28', description: 'Personal Grocery Shopping', amount: -amounts.personal, category: 'Personal Expense', deductible: false }
        ];
        
        // Apply country-specific tax rules
        const countryCode = localStorage.getItem('selectedCountry') || document.getElementById("countrySelector").value || 'US';
        const processedResults = applyCountryTaxRules(mockResults, countryCode, currency);
        console.log("Applying tax rules for country:", countryCode);
        
        // Store results in database if user is logged in
        try {
          const { data: { user } } = await supabaseClient.auth.getUser();
          if (user) {
            for (const transaction of processedResults) {
              await supabaseClient.from('transactions').insert({
                user_id: user.id,
                date: transaction.date,
                description: transaction.description,
                amount: transaction.amount,
                category: transaction.category,
                deductible: transaction.deductible,
                currency: currency,
                tax_rule: transaction.tax_rule,
                country_code: countryCode,
                created_at: new Date().toISOString()
              });
            }
          }
        } catch (error) {
          console.log('Note: Transaction data not saved to database (demo mode)');
        }
        
        let html = `<div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
          <h3 class="text-green-800 font-bold mb-2"><i class="fas fa-check-circle mr-2"></i>AI Processing Complete!</h3>
          <p class="text-green-700">Found ${processedResults.length} transactions. Applied ${countryCode} tax rules automatically.</p>
        </div>`;
        
        html += '<div class="overflow-x-auto"><table class="w-full border-collapse border border-gray-300">';
        html += '<thead><tr class="bg-gray-100"><th class="border border-gray-300 p-2">Date</th><th class="border border-gray-300 p-2">Description</th><th class="border border-gray-300 p-2">Amount</th><th class="border border-gray-300 p-2">Category</th><th class="border border-gray-300 p-2">Tax Status</th><th class="border border-gray-300 p-2">Tax Rule</th></tr></thead><tbody>';
        
        processedResults.forEach(item => {
          const rowClass = item.deductible ? 'bg-green-50' : 'bg-gray-50';
          const statusBadge = item.deductible ? '<span class="bg-green-500 text-white px-2 py-1 rounded text-xs">‚úì Deductible</span>' : '<span class="bg-gray-500 text-white px-2 py-1 rounded text-xs">Personal</span>';
          html += `<tr class="${rowClass}">
            <td class="border border-gray-300 p-2">${item.date}</td>
            <td class="border border-gray-300 p-2">${item.description}</td>
            <td class="border border-gray-300 p-2 ${item.amount < 0 ? 'text-red-600' : 'text-green-600'}">${item.amount < 0 ? '-' : '+'}${currencySymbol}${Math.abs(item.amount).toFixed(2)}</td>
            <td class="border border-gray-300 p-2">${item.category}</td>
            <td class="border border-gray-300 p-2">${statusBadge}</td>
            <td class="border border-gray-300 p-2 text-xs text-blue-600">${item.tax_rule || 'Standard rule'}</td>
          </tr>`;
        });
        
        html += '</tbody></table></div>';
        
        const totalDeductible = processedResults.filter(item => item.deductible && item.amount < 0).reduce((sum, item) => sum + Math.abs(item.amount), 0);
        const totalIncome = processedResults.filter(item => !item.deductible && item.amount > 0).reduce((sum, item) => sum + item.amount, 0);
        
        html += `<div class="mt-4 p-4 bg-blue-50 rounded-lg">
          <h4 class="font-bold text-blue-800 mb-2">Tax Summary (${countryCode} Rules Applied)</h4>
          <p class="text-blue-700">Total Deductible Expenses: ${currencySymbol}${totalDeductible.toFixed(2)}</p>
          <p class="text-blue-700">Business Income: ${currencySymbol}${totalIncome.toFixed(2)}</p>
          <p class="text-blue-700">Net Business Profit: ${currencySymbol}${(totalIncome - totalDeductible).toFixed(2)}</p>
          <p class="text-blue-600 text-sm mt-2">‚úì Transactions sorted according to ${countryCode} tax requirements</p>
        </div>`;
        
        html += '<div class="mt-4"><button onclick="loadStoredTransactions()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"><i class="fas fa-history mr-2"></i>View All Stored Transactions</button></div>';
        
        resultsDiv.innerHTML = html;
      }, 2000);
    };
    
    // Load stored transactions
    window.loadStoredTransactions = async function() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
          alert('Please sign in to view stored transactions');
          return;
        }
        
        const { data: transactions, error } = await supabaseClient
          .from('transactions')
          .select('*')
          .eq('user_id', user.id)
          .order('date', { ascending: false });
        
        if (error) {
          console.error('Error loading transactions:', error);
          alert('Error loading stored transactions');
          return;
        }
        
        const resultsDiv = document.getElementById('aiResults');
        if (transactions.length === 0) {
          resultsDiv.innerHTML = '<div class="text-gray-500 text-center py-4">No stored transactions found. Process some bank statements first!</div>';
          return;
        }
        
        // Group transactions by month
        const transactionsByMonth = {};
        transactions.forEach(transaction => {
          const monthKey = transaction.date.substring(0, 7); // YYYY-MM
          if (!transactionsByMonth[monthKey]) {
            transactionsByMonth[monthKey] = [];
          }
          transactionsByMonth[monthKey].push(transaction);
        });
        
        let html = `<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
          <h3 class="text-blue-800 font-bold mb-2"><i class="fas fa-database mr-2"></i>Your Monthly Statement History</h3>
          <p class="text-blue-700">Showing ${transactions.length} stored transactions organized by month</p>
          <div class="mt-3 flex flex-wrap gap-2">
            <button onclick="exportAllTransactionsCSV()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
              <i class="fas fa-download mr-1"></i>Export All CSV
            </button>
            <button onclick="exportTaxSummaryPDF()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
              <i class="fas fa-file-pdf mr-1"></i>Tax Summary PDF
            </button>
          </div>
        </div>`;
        
        // Display each month's transactions
        Object.keys(transactionsByMonth).sort().reverse().forEach(monthKey => {
          const monthTransactions = transactionsByMonth[monthKey];
          const monthName = new Date(monthKey + '-01').toLocaleString('default', { month: 'long', year: 'numeric' });
          
          const monthDeductible = monthTransactions.filter(item => item.deductible && item.amount < 0).reduce((sum, item) => sum + Math.abs(item.amount), 0);
          const monthIncome = monthTransactions.filter(item => !item.deductible && item.amount > 0).reduce((sum, item) => sum + item.amount, 0);
          const mainCurrency = monthTransactions[0]?.currency || window.selectedCurrency || 'USD';
          const currencySymbol = getCurrencySymbol(mainCurrency);
          
          html += `<div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
            <div class="flex justify-between items-center mb-3">
              <h4 class="text-lg font-bold text-gray-800">${monthName}</h4>
              <div class="flex space-x-2">
                <button onclick="exportMonthCSV('${monthKey}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs">
                  <i class="fas fa-download mr-1"></i>Export Month
                </button>
                <span class="text-sm text-gray-600">${monthTransactions.length} transactions</span>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3 text-sm">
              <div class="bg-green-50 p-2 rounded">
                <span class="text-green-700 font-medium">Income: ${currencySymbol}${monthIncome.toFixed(2)}</span>
              </div>
              <div class="bg-red-50 p-2 rounded">
                <span class="text-red-700 font-medium">Deductible: ${currencySymbol}${monthDeductible.toFixed(2)}</span>
              </div>
              <div class="bg-blue-50 p-2 rounded">
                <span class="text-blue-700 font-medium">Net: ${currencySymbol}${(monthIncome - monthDeductible).toFixed(2)}</span>
              </div>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full border-collapse border border-gray-300 text-sm">
                <thead><tr class="bg-gray-100"><th class="border border-gray-300 p-1">Date</th><th class="border border-gray-300 p-1">Description</th><th class="border border-gray-300 p-1">Amount</th><th class="border border-gray-300 p-1">Category</th><th class="border border-gray-300 p-1">Status</th></tr></thead>
                <tbody>`;
          
          monthTransactions.forEach(item => {
            const rowClass = item.deductible ? 'bg-green-50' : 'bg-gray-50';
            const statusBadge = item.deductible ? '<span class="bg-green-500 text-white px-1 py-0.5 rounded text-xs">‚úì Deductible</span>' : '<span class="bg-gray-500 text-white px-1 py-0.5 rounded text-xs">Personal</span>';
            const currencySymbol = getCurrencySymbol(item.currency || 'USD');
            
            html += `<tr class="${rowClass}">
              <td class="border border-gray-300 p-1">${item.date}</td>
              <td class="border border-gray-300 p-1">${item.description}</td>
              <td class="border border-gray-300 p-1 ${item.amount < 0 ? 'text-red-600' : 'text-green-600'}">${item.amount < 0 ? '-' : '+'}${currencySymbol}${Math.abs(item.amount).toFixed(2)}</td>
              <td class="border border-gray-300 p-1">${item.category}</td>
              <td class="border border-gray-300 p-1">${statusBadge}</td>
            </tr>`;
          });
          
          html += '</tbody></table></div></div>';
        });
        
        const totalDeductible = transactions.filter(item => item.deductible && item.amount < 0).reduce((sum, item) => sum + Math.abs(item.amount), 0);
        const totalIncome = transactions.filter(item => !item.deductible && item.amount > 0).reduce((sum, item) => sum + item.amount, 0);
        const mainCurrency = transactions[0]?.currency || window.selectedCurrency || 'USD';
        const currencySymbol = getCurrencySymbol(mainCurrency);
        
        html += `<div class="mt-4 p-4 bg-green-50 rounded-lg">
          <h4 class="font-bold text-green-800 mb-2">Total Tax Summary (All Time)</h4>
          <p class="text-green-700">Total Deductible Expenses: ${currencySymbol}${totalDeductible.toFixed(2)}</p>
          <p class="text-green-700">Total Business Income: ${currencySymbol}${totalIncome.toFixed(2)}</p>
          <p class="text-green-700">Net Business Profit: ${currencySymbol}${(totalIncome - totalDeductible).toFixed(2)}</p>
        </div>`;
        
        resultsDiv.innerHTML = html;
        
      } catch (error) {
        console.error('Error in loadStoredTransactions:', error);
        alert('Error loading transactions. Please try again.');
      }
    };
    
    // Export functions for monthly history
    window.exportAllTransactionsCSV = function() {
      alert('CSV export would download all your transactions in spreadsheet format, organized by month for easy tax filing.');
    };
    
    window.exportTaxSummaryPDF = function() {
      alert('PDF export would generate a professional tax summary report with all deductible expenses and income totals.');
    };
    
    window.exportMonthCSV = function(monthKey) {
      const monthName = new Date(monthKey + '-01').toLocaleString('default', { month: 'long', year: 'numeric' });
      alert(`CSV export would download all transactions for ${monthName} in spreadsheet format.`);
    };

    // Export functions (simplified for demo)
    window.exportReportPDF = function() {
      alert('PDF export feature would generate a professional report file here. This requires additional PDF generation libraries in production.');
    };

    window.exportReportCSV = function() {
      alert('CSV export feature would download your data in spreadsheet format here. Perfect for sharing with your accountant!');
    };

    window.setBudgets = function() {
      alert('Budget editing feature would allow you to set custom monthly limits for each expense category.');
    };
  </script>

  <!-- UI Frameworks -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  
  <style>
    .glass-effect {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .fade-in {
      animation: fadeIn 0.8s ease-in;
    }
    .bounce-in {
      animation: bounceIn 1s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">

  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="glass-effect rounded-3xl shadow-2xl p-8 w-full max-w-md fade-in">
      <div class="text-center mb-8">
        <div class="gradient-bg w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 bounce-in">
          <i class="fas fa-globe text-white text-3xl"></i>
        </div>
        <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">Global Accounting</h1>
        <p class="text-gray-600">AI-Powered Professional Dashboard v15</p>
      </div>

      <!-- Country selector -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Select Your Country</label>
        <select id="countrySelector" onchange="setUserCountry()" class="w-full border rounded-xl py-3 px-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="">-- Select Country --</option>
        </select>
      </div>

      <!-- Google login button -->
      <button onclick="signInWithGoogle()" class="w-full gradient-bg text-white rounded-xl py-3 px-4 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
        <i class="fab fa-google mr-2"></i> Sign in with Google
      </button>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard" class="hidden p-6">
    <!-- Header with Sign Out -->
    <div class="flex items-center justify-between mb-6 bg-white rounded-2xl p-4 shadow-lg">
      <div class="flex items-center space-x-4">
        <img id="userAvatar" class="w-12 h-12 rounded-full border-2 border-blue-500" src="" alt="User Avatar">
        <div>
          <h2 id="userName" class="text-2xl font-bold text-gray-800"></h2>
          <p class="text-gray-600">Welcome back!</p>
        </div>
      </div>
      <button onclick="signOut()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors duration-200">
        <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
      </button>
    </div>

    <!-- Deadline Reminders -->
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4"><i class="fas fa-clock mr-2 text-orange-500"></i>Tax Deadline Timers</h2>
      <div id="deadlineReminders" class="space-y-3">
        <div class="text-gray-500 text-center py-8 bg-white rounded-xl">
          <i class="fas fa-calendar-alt text-4xl mb-4 text-gray-300"></i>
          <p>Select your country to see tax deadlines with live countdowns</p>
        </div>
      </div>
    </div>

    <!-- Smart Receipt Scanner -->
    <div class="glass-effect rounded-2xl p-6 mb-6 shadow-lg">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">
        <i class="fas fa-camera mr-2 text-purple-500"></i>Smart Receipt Scanner
      </h2>
      <p class="text-gray-600 mb-4">Take photos of receipts and let AI extract all the details automatically</p>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Receipt Photos</label>
        <input type="file" id="receiptPhotos" multiple accept="image/*" capture="environment" class="w-full border-2 border-dashed border-purple-300 rounded-lg p-4 hover:border-purple-400 transition-colors">
      </div>
      
      <button onclick="scanReceipts()" class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-6 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200">
        <i class="fas fa-scan mr-2"></i>Scan Receipts with AI
      </button>
      
      <div id="receiptResults" class="mt-6"></div>
    </div>

    <!-- AI Bank Statement Processing -->
    <div class="glass-effect rounded-2xl p-6 mb-6 shadow-lg">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">
        <i class="fas fa-robot mr-2 text-blue-500"></i>AI Bank Statement Processor
      </h2>
      <p class="text-gray-600 mb-4">Upload your bank statements and let AI automatically categorize transactions for tax compliance</p>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Bank Statements (CSV, PDF, Excel)</label>
        <input type="file" id="bankStatements" multiple accept=".csv,.pdf,.xlsx,.xls" class="w-full border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-blue-400 transition-colors">
      </div>
      
      <button onclick="processStatements()" class="gradient-bg text-white py-3 px-6 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200">
        <i class="fas fa-magic mr-2"></i>Process with AI
      </button>
      
      <div id="aiResults" class="mt-6"></div>
    </div>

    <!-- Business Reports & Analytics -->
    <div class="glass-effect rounded-2xl p-6 mb-6 shadow-lg">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">
        <i class="fas fa-chart-line mr-2 text-green-500"></i>Business Reports & Analytics
      </h2>
      <p class="text-gray-600 mb-4">Generate professional reports and get AI insights about your business spending</p>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <button onclick="generateMonthlyReport()" class="bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg transition-all duration-200">
          <i class="fas fa-file-alt mr-2"></i>Monthly P&L Report
        </button>
        <button onclick="getBusinessInsights()" class="bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-lg transition-all duration-200">
          <i class="fas fa-lightbulb mr-2"></i>AI Business Insights
        </button>
        <button onclick="showBudgetTracker()" class="bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-4 rounded-lg transition-all duration-200">
          <i class="fas fa-piggy-bank mr-2"></i>Budget Tracker
        </button>
      </div>
      
      <div id="reportsResults" class="mt-6"></div>
    </div>

    <!-- Business Profile -->
    <div class="glass-effect rounded-2xl p-6 shadow-lg">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">
        <i class="fas fa-building mr-2 text-green-500"></i>Business Profile
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="businessName" placeholder="Business Name" class="border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <input type="text" id="taxNumber" placeholder="Tax Number" class="border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>
      
      <select id="businessType" class="w-full border rounded-lg p-3 mt-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <option value="">-- Select Business Type --</option>
        <option value="sole_prop">Sole Proprietor</option>
        <option value="company">Company</option>
        <option value="partnership">Partnership</option>
        <option value="non_profit">Non-Profit</option>
      </select>

      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Tax Reminder Preferences</label>
        <div class="flex space-x-6">
          <label class="flex items-center">
            <input type="checkbox" id="prefersPersonal" class="mr-2 text-blue-500 focus:ring-blue-500">
            <span>Personal Deadlines</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" id="prefersBusiness" class="mr-2 text-blue-500 focus:ring-blue-500">
            <span>Business Deadlines</span>
          </label>
        </div>
      </div>

      <button onclick="saveBusinessProfile()" class="gradient-bg text-white py-3 px-6 rounded-lg mt-4 hover:shadow-lg transform hover:scale-105 transition-all duration-200">
        <i class="fas fa-save mr-2"></i>Save Profile
      </button>
      <div id="profileSavedMsg" class="text-green-600 mt-3 hidden">
        <i class="fas fa-check-circle mr-2"></i>Profile saved successfully!
      </div>
    </div>
  </div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98012930b5ab06db',t:'MTc1ODAzNDA2Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
