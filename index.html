<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZA Accounting Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; height: 280px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <!-- Authentication Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-slate-900 rounded-lg flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-slate-900">Welcome to Global Accountant</h2>
                <p class="text-slate-600 mt-2">Sign in to access your business dashboard</p>
            </div>

            <!-- Auth Toggle -->
            <div class="flex bg-slate-100 rounded-lg p-1 mb-6">
                <button id="loginTab" class="flex-1 py-2 px-4 rounded-md text-sm font-medium bg-white text-slate-900 shadow-sm">
                    Sign In
                </button>
                <button id="signupTab" class="flex-1 py-2 px-4 rounded-md text-sm font-medium text-slate-600 hover:text-slate-900">
                    Sign Up
                </button>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <form id="emailLoginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                        <input type="email" id="loginEmail" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                        <input type="password" id="loginPassword" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent">
                    </div>
                    <button type="submit" id="loginBtn" class="w-full bg-slate-900 text-white py-2 px-4 rounded-lg hover:bg-slate-800 transition-colors font-medium">
                        Sign In
                    </button>
                </form>

                <div class="my-6 flex items-center">
                    <div class="flex-1 border-t border-slate-300"></div>
                    <span class="px-4 text-sm text-slate-500">or</span>
                    <div class="flex-1 border-t border-slate-300"></div>
                </div>

                <button id="googleLoginBtn" class="w-full flex items-center justify-center space-x-3 px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span class="text-sm font-medium">Continue with Google</span>
                </button>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" class="hidden">
                <form id="emailSignupForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Full Name</label>
                        <input type="text" id="signupName" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                        <input type="email" id="signupEmail" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                        <input type="password" id="signupPassword" required minlength="6" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent">
                        <p class="text-xs text-slate-500 mt-1">Minimum 6 characters</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Business Name</label>
                        <input type="text" id="signupBusiness" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent">
                    </div>
                    <button type="submit" id="signupBtn" class="w-full bg-slate-900 text-white py-2 px-4 rounded-lg hover:bg-slate-800 transition-colors font-medium">
                        Create Account
                    </button>
                </form>

                <div class="my-6 flex items-center">
                    <div class="flex-1 border-t border-slate-300"></div>
                    <span class="px-4 text-sm text-slate-500">or</span>
                    <div class="flex-1 border-t border-slate-300"></div>
                </div>

                <button id="googleSignupBtn" class="w-full flex items-center justify-center space-x-3 px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span class="text-sm font-medium">Sign up with Google</span>
                </button>
            </div>

            <!-- Loading State -->
            <div id="authLoading" class="hidden text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-900 mx-auto mb-4"></div>
                <p class="text-slate-600">Signing you in...</p>
            </div>

            <!-- Error Message -->
            <div id="authError" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-600 text-sm"></p>
            </div>
        </div>
    </div>

    <div id="app" class="min-h-screen flex">
        <!-- Sidebar -->
        <div class="w-72 bg-white border-r border-slate-200 flex-shrink-0">
            <div class="p-8">
                <div class="flex items-center space-x-3 mb-12">
                    <div class="w-10 h-10 bg-slate-900 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <div class="text-xl font-bold text-slate-900">Global Accountant</div>
                        <div class="text-sm text-slate-500">Business Suite</div>
                    </div>
                </div>
                
                <nav class="space-y-1">
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 text-slate-900 bg-slate-100 rounded-lg font-medium border-l-4 border-slate-900">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z"></path>
                        </svg>
                        <span>Overview</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg font-medium transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>Invoices</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg font-medium transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span>Expenses</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg font-medium transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span>Reports</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg font-medium transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>VAT Summary</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg font-medium transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        <span>Ask AI</span>
                    </a>
                    
                    <!-- Country Selector in Sidebar -->
                    <div class="mt-8 pt-6 border-t border-slate-200">
                        <div class="px-4 mb-3">
                            <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Region</p>
                        </div>
                        <div class="relative">
                            <button id="sidebarCountryBtn" class="w-full flex items-center space-x-3 px-4 py-3 text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg font-medium transition-all">
                                <span id="sidebarSelectedFlag" class="text-lg">ðŸ‡¿ðŸ‡¦</span>
                                <div class="flex-1 text-left">
                                    <div id="sidebarSelectedCountry" class="text-sm font-medium">South Africa</div>
                                    <div id="sidebarSelectedCurrency" class="text-xs text-slate-500">ZAR (R)</div>
                                </div>
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            <div id="sidebarCountryDropdown" class="hidden absolute left-0 bottom-full mb-2 w-full bg-white rounded-lg shadow-lg border border-slate-200 py-2 z-50 max-h-80 overflow-y-auto">
                                <div class="px-3 py-2 text-xs font-medium text-slate-500 uppercase tracking-wide border-b border-slate-100">Select Country</div>
                                <button class="sidebar-country-option w-full flex items-center space-x-3 px-4 py-2 hover:bg-slate-50 text-left" data-country="ZA" data-flag="ðŸ‡¿ðŸ‡¦" data-name="South Africa" data-currency="ZAR" data-symbol="R" data-vat="15">
                                    <span class="text-lg">ðŸ‡¿ðŸ‡¦</span>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-slate-900">South Africa</div>
                                        <div class="text-xs text-slate-500">VAT 15% â€¢ ZAR (R)</div>
                                    </div>
                                </button>
                                <button class="sidebar-country-option w-full flex items-center space-x-3 px-4 py-2 hover:bg-slate-50 text-left" data-country="US" data-flag="ðŸ‡ºðŸ‡¸" data-name="United States" data-currency="USD" data-symbol="$" data-vat="0">
                                    <span class="text-lg">ðŸ‡ºðŸ‡¸</span>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-slate-900">United States</div>
                                        <div class="text-xs text-slate-500">Sales Tax varies â€¢ USD ($)</div>
                                    </div>
                                </button>
                                <button class="sidebar-country-option w-full flex items-center space-x-3 px-4 py-2 hover:bg-slate-50 text-left" data-country="GB" data-flag="ðŸ‡¬ðŸ‡§" data-name="United Kingdom" data-currency="GBP" data-symbol="Â£" data-vat="20">
                                    <span class="text-lg">ðŸ‡¬ðŸ‡§</span>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-slate-900">United Kingdom</div>
                                        <div class="text-xs text-slate-500">VAT 20% â€¢ GBP (Â£)</div>
                                    </div>
                                </button>
                                <button class="sidebar-country-option w-full flex items-center space-x-3 px-4 py-2 hover:bg-slate-50 text-left" data-country="CA" data-flag="ðŸ‡¨ðŸ‡¦" data-name="Canada" data-currency="CAD" data-symbol="C$" data-vat="13">
                                    <span class="text-lg">ðŸ‡¨ðŸ‡¦</span>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-slate-900">Canada</div>
                                        <div class="text-xs text-slate-500">HST 13% â€¢ CAD (C$)</div>
                                    </div>
                                </button>
                                <button class="sidebar-country-option w-full flex items-center space-x-3 px-4 py-2 hover:bg-slate-50 text-left" data-country="AU" data-flag="ðŸ‡¦ðŸ‡º" data-name="Australia" data-currency="AUD" data-symbol="A$" data-vat="10">
                                    <span class="text-lg">ðŸ‡¦ðŸ‡º</span>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-slate-900">Australia</div>
                                        <div class="text-xs text-slate-500">GST 10% â€¢ AUD (A$)</div>
                                    </div>
                                </button>
                                <button class="sidebar-country-option w-full flex items-center space-x-3 px-4 py-2 hover:bg-slate-50 text-left" data-country="DE" data-flag="ðŸ‡©ðŸ‡ª" data-name="Germany" data-currency="EUR" data-symbol="â‚¬" data-vat="19">
                                    <span class="text-lg">ðŸ‡©ðŸ‡ª</span>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-slate-900">Germany</div>
                                        <div class="text-xs text-slate-500">VAT 19% â€¢ EUR (â‚¬)</div>
                                    </div>
                                </button>
                                <button class="sidebar-country-option w-full flex items-center space-x-3 px-4 py-2 hover:bg-slate-50 text-left" data-country="FR" data-flag="ðŸ‡«ðŸ‡·" data-name="France" data-currency="EUR" data-symbol="â‚¬" data-vat="20">
                                    <span class="text-lg">ðŸ‡«ðŸ‡·</span>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-slate-900">France</div>
                                        <div class="text-xs text-slate-500">VAT 20% â€¢ EUR (â‚¬)</div>
                                    </div>
                                </button>
                                <button class="sidebar-country-option w-full flex items-center space-x-3 px-4 py-2 hover:bg-slate-50 text-left" data-country="IN" data-flag="ðŸ‡®ðŸ‡³" data-name="India" data-currency="INR" data-symbol="â‚¹" data-vat="18">
                                    <span class="text-lg">ðŸ‡®ðŸ‡³</span>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-slate-900">India</div>
                                        <div class="text-xs text-slate-500">GST 18% â€¢ INR (â‚¹)</div>
                                    </div>
                                </button>
                                <button class="sidebar-country-option w-full flex items-center space-x-3 px-4 py-2 hover:bg-slate-50 text-left" data-country="SG" data-flag="ðŸ‡¸ðŸ‡¬" data-name="Singapore" data-currency="SGD" data-symbol="S$" data-vat="8">
                                    <span class="text-lg">ðŸ‡¸ðŸ‡¬</span>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-slate-900">Singapore</div>
                                        <div class="text-xs text-slate-500">GST 8% â€¢ SGD (S$)</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Top Bar -->
            <header class="bg-white border-b border-slate-200 px-8 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 id="businessName" class="text-2xl font-bold text-slate-900">Your Business</h1>
                        <div class="flex items-center space-x-4">
                            <p class="text-slate-500 text-sm">Registration: 2019/123456/07</p>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                <span class="text-sm font-medium text-emerald-700">Active</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <button id="profileBtn" class="flex items-center space-x-3 px-4 py-2 hover:bg-slate-50 rounded-lg transition-colors">
                                <div class="text-right">
                                    <div id="userDisplayName" class="text-sm font-medium text-slate-900">Loading...</div>
                                    <div class="text-xs text-slate-500">Administrator</div>
                                </div>
                                <div id="userAvatar" class="w-10 h-10 bg-slate-900 rounded-lg flex items-center justify-center">
                                    <span class="text-white font-medium text-sm">?</span>
                                </div>
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-slate-200 py-2 z-50">
                                <div class="px-4 py-2 border-b border-slate-100">
                                    <div id="dropdownUserName" class="text-sm font-medium text-slate-900">Loading...</div>
                                    <div id="dropdownUserEmail" class="text-xs text-slate-500">Loading...</div>
                                    <div id="authProvider" class="text-xs text-emerald-600 mt-1 hidden">
                                        <svg class="w-3 h-3 inline mr-1" viewBox="0 0 24 24">
                                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                        </svg>
                                        Signed in with Google
                                    </div>
                                </div>
                                <a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">Account Settings</a>
                                <a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">Business Profile</a>
                                <a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">Billing & Subscription</a>
                                <hr class="my-2">
                                <a href="#" id="signOutBtn" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">Sign Out</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <main class="flex-1 p-8 bg-slate-50">
                <!-- Key Metrics Row -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg p-6 border border-slate-200" data-metric="revenue">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-600">Monthly Revenue</p>
                                <p class="text-2xl font-bold text-slate-900">R 94,250</p>
                                <p class="text-sm text-emerald-600">+12.5% from last month</p>
                            </div>
                            <div class="w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-6 border border-slate-200" data-metric="outstanding">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-600">Outstanding Invoices</p>
                                <p class="text-2xl font-bold text-slate-900">R 18,750</p>
                                <p class="text-sm text-amber-600">7 invoices pending</p>
                            </div>
                            <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-6 border border-slate-200" data-metric="expenses">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-600">Monthly Expenses</p>
                                <p class="text-2xl font-bold text-slate-900">R 31,200</p>
                                <p class="text-sm text-slate-500">-5.2% from last month</p>
                            </div>
                            <div class="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tax Status Card -->
                    <div id="taxCard" class="bg-red-600 rounded-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p id="taxLabel" class="text-sm font-medium text-red-100">VAT Payment Due</p>
                                <p id="taxAmount" class="text-2xl font-bold">R 1,245</p>
                                <p class="text-sm text-red-100">Due: 25 January 2024</p>
                            </div>
                            <div class="w-12 h-12 bg-red-500 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <button class="mt-4 w-full bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg py-2 text-sm font-medium transition-colors">
                            Make Payment
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <!-- Cash Flow Chart -->
                    <div class="lg:col-span-2 bg-white rounded-lg border border-slate-200">
                        <div class="p-6 border-b border-slate-200">
                            <h3 class="text-lg font-semibold text-slate-900">Cash Flow Analysis</h3>
                            <p class="text-sm text-slate-500">Monthly income vs expenses comparison</p>
                        </div>
                        <div class="p-6">
                            <div class="chart-container">
                                <canvas id="cashFlowChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Income vs Expenses -->
                    <div class="bg-white rounded-lg border border-slate-200">
                        <div class="p-6 border-b border-slate-200">
                            <h3 class="text-lg font-semibold text-slate-900">Financial Overview</h3>
                            <p class="text-sm text-slate-500">Current period breakdown</p>
                        </div>
                        <div class="p-6">
                            <div class="chart-container">
                                <canvas id="pieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Compliance Deadlines -->
                    <div class="bg-white rounded-lg border border-slate-200">
                        <div class="p-6 border-b border-slate-200">
                            <h3 class="text-lg font-semibold text-slate-900">Compliance Calendar</h3>
                            <p class="text-sm text-slate-500">Upcoming SARS & CIPC deadlines</p>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div class="flex items-center space-x-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                    <div class="flex-1">
                                        <div class="font-medium text-slate-900">VAT Return Submission</div>
                                        <div class="text-sm text-slate-600">SARS eFiling Portal</div>
                                        <div class="text-sm text-red-600 font-medium">Due: 25 January 2024</div>
                                    </div>
                                    <span class="text-red-600 font-bold text-sm">3 days</span>
                                </div>
                                
                                <div class="flex items-center space-x-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                    <div class="w-3 h-3 bg-amber-500 rounded-full"></div>
                                    <div class="flex-1">
                                        <div class="font-medium text-slate-900">UIF Monthly Declaration</div>
                                        <div class="text-sm text-slate-600">Department of Labour</div>
                                        <div class="text-sm text-amber-600 font-medium">Due: 7 February 2024</div>
                                    </div>
                                    <span class="text-amber-600 font-bold text-sm">16 days</span>
                                </div>
                                
                                <div class="flex items-center space-x-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                    <div class="flex-1">
                                        <div class="font-medium text-slate-900">Annual Return Filing</div>
                                        <div class="text-sm text-slate-600">CIPC Online Portal</div>
                                        <div class="text-sm text-blue-600 font-medium">Due: 15 February 2024</div>
                                    </div>
                                    <span class="text-blue-600 font-bold text-sm">24 days</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white rounded-lg border border-slate-200">
                        <div class="p-6 border-b border-slate-200">
                            <h3 class="text-lg font-semibold text-slate-900">Quick Actions</h3>
                            <p class="text-sm text-slate-500">Common business tasks</p>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 gap-4">
                                <button class="flex items-center justify-between p-4 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors text-left">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="font-medium text-slate-900">Create Invoice</div>
                                            <div class="text-sm text-slate-500">Generate new customer invoice</div>
                                        </div>
                                    </div>
                                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                                
                                <button class="flex items-center justify-between p-4 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors text-left">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="font-medium text-slate-900">Record Expense</div>
                                            <div class="text-sm text-slate-500">Log business expenditure</div>
                                        </div>
                                    </div>
                                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                                
                                <button id="uploadBankStatement" class="flex items-center justify-between p-4 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors text-left">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="font-medium text-slate-900">Upload Bank Statement</div>
                                            <div class="text-sm text-slate-500">AI will auto-capture transactions</div>
                                        </div>
                                    </div>
                                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                                
                                <button class="flex items-center justify-between p-4 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors text-left">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="font-medium text-slate-900">Generate Report</div>
                                            <div class="text-sm text-slate-500">Financial statements & analytics</div>
                                        </div>
                                    </div>
                                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://ehpjupxbworwiepbuxkn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVocGp1cHhid29yd2llcGJ1eGtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4Mzg5MTQsImV4cCI6MjA2OTQxNDkxNH0.uLGrwVrYn2hk_H5h40H731BvbwIRJPmt_AZTUFbtxH0';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global state
        let currentUser = null;
        let userProfile = null;
        
        // Current country configuration
        let currentCountry = {
            code: 'ZA',
            name: 'South Africa',
            flag: 'ðŸ‡¿ðŸ‡¦',
            currency: 'ZAR',
            symbol: 'R',
            vatRate: 15,
            taxName: 'VAT'
        };
        
        // Country configurations
        const countryConfigs = {
            'ZA': { name: 'South Africa', flag: 'ðŸ‡¿ðŸ‡¦', currency: 'ZAR', symbol: 'R', vatRate: 15, taxName: 'VAT' },
            'US': { name: 'United States', flag: 'ðŸ‡ºðŸ‡¸', currency: 'USD', symbol: '$', vatRate: 0, taxName: 'Sales Tax' },
            'GB': { name: 'United Kingdom', flag: 'ðŸ‡¬ðŸ‡§', currency: 'GBP', symbol: 'Â£', vatRate: 20, taxName: 'VAT' },
            'CA': { name: 'Canada', flag: 'ðŸ‡¨ðŸ‡¦', currency: 'CAD', symbol: 'C$', vatRate: 13, taxName: 'HST' },
            'AU': { name: 'Australia', flag: 'ðŸ‡¦ðŸ‡º', currency: 'AUD', symbol: 'A$', vatRate: 10, taxName: 'GST' },
            'DE': { name: 'Germany', flag: 'ðŸ‡©ðŸ‡ª', currency: 'EUR', symbol: 'â‚¬', vatRate: 19, taxName: 'VAT' },
            'FR': { name: 'France', flag: 'ðŸ‡«ðŸ‡·', currency: 'EUR', symbol: 'â‚¬', vatRate: 20, taxName: 'VAT' },
            'IN': { name: 'India', flag: 'ðŸ‡®ðŸ‡³', currency: 'INR', symbol: 'â‚¹', vatRate: 18, taxName: 'GST' },
            'SG': { name: 'Singapore', flag: 'ðŸ‡¸ðŸ‡¬', currency: 'SGD', symbol: 'S$', vatRate: 8, taxName: 'GST' }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is already logged in
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                await loadUserProfile();
                showDashboard();
            } else {
                showAuthModal();
            }

            // Listen for auth changes
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    await loadUserProfile();
                    showDashboard();
                    hideAuthModal();
                    showNotification('Successfully signed in!', 'success');
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    userProfile = null;
                    showAuthModal();
                    showNotification('Signed out successfully', 'info');
                }
            });

            setupEventListeners();
            initializeCharts();
        });

        // Load user profile from database
        async function loadUserProfile() {
            if (!currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading profile:', error);
                    return;
                }

                userProfile = data;
                
                // If no profile exists, create one
                if (!data) {
                    await createUserProfile();
                }
                
                updateUserDisplay();
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        // Create user profile in database
        async function createUserProfile() {
            if (!currentUser) return;

            const profileData = {
                id: currentUser.id,
                email: currentUser.email,
                full_name: currentUser.user_metadata?.full_name || currentUser.email.split('@')[0],
                business_name: 'Your Business',
                country_code: 'ZA',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .insert([profileData])
                    .select()
                    .single();

                if (error) {
                    console.error('Error creating profile:', error);
                    return;
                }

                userProfile = data;
                updateUserDisplay();
            } catch (error) {
                console.error('Error creating user profile:', error);
            }
        }

        // Update user display in UI
        function updateUserDisplay() {
            if (!currentUser) return;

            const displayName = userProfile?.full_name || currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
            const businessName = userProfile?.business_name || 'Your Business';
            const email = currentUser.email;
            
            // Update profile display
            document.getElementById('userDisplayName').textContent = displayName;
            document.getElementById('dropdownUserName').textContent = displayName;
            document.getElementById('dropdownUserEmail').textContent = email;
            document.getElementById('businessName').textContent = businessName;
            
            // Update avatar
            const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            document.getElementById('userAvatar').innerHTML = `<span class="text-white font-medium text-sm">${initials}</span>`;
            
            // Show auth provider if Google
            if (currentUser.app_metadata?.provider === 'google') {
                document.getElementById('authProvider').classList.remove('hidden');
            }

            // Load user's country preference
            if (userProfile?.country_code && countryConfigs[userProfile.country_code]) {
                currentCountry = {
                    code: userProfile.country_code,
                    ...countryConfigs[userProfile.country_code]
                };
                updateCountryDisplay();
                updateFinancialData();
            }
        }

        // Show/hide modals
        function showAuthModal() {
            document.getElementById('authModal').classList.remove('hidden');
            document.getElementById('app').style.display = 'none';
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('app').style.display = 'flex';
        }

        function showDashboard() {
            document.getElementById('app').style.display = 'flex';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auth modal tab switching
            document.getElementById('loginTab').addEventListener('click', function() {
                this.classList.add('bg-white', 'text-slate-900', 'shadow-sm');
                this.classList.remove('text-slate-600');
                document.getElementById('signupTab').classList.remove('bg-white', 'text-slate-900', 'shadow-sm');
                document.getElementById('signupTab').classList.add('text-slate-600');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('signupForm').classList.add('hidden');
            });

            document.getElementById('signupTab').addEventListener('click', function() {
                this.classList.add('bg-white', 'text-slate-900', 'shadow-sm');
                this.classList.remove('text-slate-600');
                document.getElementById('loginTab').classList.remove('bg-white', 'text-slate-900', 'shadow-sm');
                document.getElementById('loginTab').classList.add('text-slate-600');
                document.getElementById('signupForm').classList.remove('hidden');
                document.getElementById('loginForm').classList.add('hidden');
            });

            // Email login form
            document.getElementById('emailLoginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                showAuthLoading();
                
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) {
                        showAuthError(error.message);
                        hideAuthLoading();
                    }
                } catch (error) {
                    showAuthError('An unexpected error occurred');
                    hideAuthLoading();
                }
            });

            // Email signup form
            document.getElementById('emailSignupForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const businessName = document.getElementById('signupBusiness').value;
                
                showAuthLoading();
                
                try {
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                full_name: name,
                                business_name: businessName
                            }
                        }
                    });

                    if (error) {
                        showAuthError(error.message);
                        hideAuthLoading();
                    } else {
                        showNotification('Account created! Please check your email to verify your account.', 'success');
                        hideAuthLoading();
                    }
                } catch (error) {
                    showAuthError('An unexpected error occurred');
                    hideAuthLoading();
                }
            });

            // Google login buttons
            document.getElementById('googleLoginBtn').addEventListener('click', signInWithGoogle);
            document.getElementById('googleSignupBtn').addEventListener('click', signInWithGoogle);

            // Sign out
            document.getElementById('signOutBtn').addEventListener('click', async function(e) {
                e.preventDefault();
                await supabase.auth.signOut();
            });

            // Profile dropdown
            document.getElementById('profileBtn').addEventListener('click', function() {
                document.getElementById('profileDropdown').classList.toggle('hidden');
            });

            // Country selector
            document.getElementById('sidebarCountryBtn').addEventListener('click', function() {
                document.getElementById('sidebarCountryDropdown').classList.toggle('hidden');
            });

            // Country selection
            document.querySelectorAll('.sidebar-country-option').forEach(option => {
                option.addEventListener('click', async function() {
                    const countryCode = this.dataset.country;
                    const config = countryConfigs[countryCode];
                    
                    currentCountry = {
                        code: countryCode,
                        name: config.name,
                        flag: config.flag,
                        currency: config.currency,
                        symbol: config.symbol,
                        vatRate: config.vatRate,
                        taxName: config.taxName
                    };
                    
                    // Save to user profile
                    if (currentUser && userProfile) {
                        await updateUserCountryPreference(countryCode);
                    }
                    
                    updateCountryDisplay();
                    updateFinancialData();
                    document.getElementById('sidebarCountryDropdown').classList.add('hidden');
                    showNotification(`Switched to ${config.name}. All values updated to ${config.currency}.`, 'success');
                });
            });

            // Click outside to close dropdowns
            document.addEventListener('click', function(event) {
                const profileBtn = document.getElementById('profileBtn');
                const profileDropdown = document.getElementById('profileDropdown');
                const sidebarCountryBtn = document.getElementById('sidebarCountryBtn');
                const sidebarCountryDropdown = document.getElementById('sidebarCountryDropdown');
                
                if (!profileBtn.contains(event.target)) {
                    profileDropdown.classList.add('hidden');
                }
                
                if (!sidebarCountryBtn.contains(event.target)) {
                    sidebarCountryDropdown.classList.add('hidden');
                }
            });

            // File upload
            document.getElementById('uploadBankStatement').addEventListener('click', handleFileUpload);
        }

        // Google authentication
        async function signInWithGoogle() {
            showAuthLoading();
            
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin
                    }
                });

                if (error) {
                    showAuthError(error.message);
                    hideAuthLoading();
                }
            } catch (error) {
                showAuthError('An unexpected error occurred');
                hideAuthLoading();
            }
        }

        // Update user country preference
        async function updateUserCountryPreference(countryCode) {
            if (!currentUser || !userProfile) return;

            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ 
                        country_code: countryCode,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);

                if (error) {
                    console.error('Error updating country preference:', error);
                } else {
                    userProfile.country_code = countryCode;
                }
            } catch (error) {
                console.error('Error updating country preference:', error);
            }
        }

        // Auth UI helpers
        function showAuthLoading() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('authLoading').classList.remove('hidden');
            document.getElementById('authError').classList.add('hidden');
        }

        function hideAuthLoading() {
            document.getElementById('authLoading').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Update country display
        function updateCountryDisplay() {
            document.getElementById('sidebarSelectedFlag').textContent = currentCountry.flag;
            document.getElementById('sidebarSelectedCountry').textContent = currentCountry.name;
            document.getElementById('sidebarSelectedCurrency').textContent = `${currentCountry.currency} (${currentCountry.symbol})`;
        }
        
        // Update financial data with new currency
        function updateFinancialData() {
            const symbol = currentCountry.symbol;
            
            // Sample conversion rates (in a real app, you'd fetch live rates)
            const conversionRates = {
                'ZAR': 1,
                'USD': 0.054,
                'GBP': 0.043,
                'EUR': 0.049,
                'CAD': 0.073,
                'AUD': 0.081,
                'INR': 4.5,
                'SGD': 0.073
            };
            
            const rate = conversionRates[currentCountry.currency] || 1;
            
            // Update revenue
            const revenue = Math.round(94250 * rate);
            document.querySelector('[data-metric="revenue"] .text-2xl').textContent = `${symbol} ${revenue.toLocaleString()}`;
            
            // Update outstanding invoices
            const outstanding = Math.round(18750 * rate);
            document.querySelector('[data-metric="outstanding"] .text-2xl').textContent = `${symbol} ${outstanding.toLocaleString()}`;
            
            // Update expenses
            const expenses = Math.round(31200 * rate);
            document.querySelector('[data-metric="expenses"] .text-2xl').textContent = `${symbol} ${expenses.toLocaleString()}`;
            
            // Update tax amount and label
            const taxAmount = Math.round(1245 * rate);
            document.getElementById('taxAmount').textContent = `${symbol} ${taxAmount.toLocaleString()}`;
            document.getElementById('taxLabel').textContent = `${currentCountry.taxName} Payment Due`;
            
            // Update chart data
            if (window.cashFlowChart && window.pieChart) {
                updateChartData(rate);
            }
        }
        
        // Update chart data with new currency
        function updateChartData(rate) {
            // Update cash flow chart
            const incomeData = [85000, 92000, 78000, 94000, 88000, 96000, 94250].map(val => Math.round(val * rate));
            const expenseData = [32000, 35000, 29000, 38000, 33000, 31000, 31200].map(val => Math.round(val * rate));
            
            window.cashFlowChart.data.datasets[0].data = incomeData;
            window.cashFlowChart.data.datasets[1].data = expenseData;
            window.cashFlowChart.update();
            
            // Update pie chart
            const netIncome = Math.round(63050 * rate);
            const totalExpenses = Math.round(31200 * rate);
            
            window.pieChart.data.datasets[0].data = [netIncome, totalExpenses];
            window.pieChart.update();
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const bgColor = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // File upload functionality
        function handleFileUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.csv,.xlsx,.xls';
            input.multiple = false;
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    // Show processing notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    notification.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                            <span>Processing ${file.name}... AI is analyzing transactions</span>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    // Simulate AI processing
                    setTimeout(() => {
                        notification.remove();
                        showNotification(`Successfully processed 47 transactions from ${file.name}`, 'success');
                    }, 3000);
                }
            };
            
            input.click();
        }

        // Initialize charts
        function initializeCharts() {
            // Cash Flow Chart
            const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
            window.cashFlowChart = new Chart(cashFlowCtx, {
                type: 'bar',
                data: {
                    labels: ['Jul 2023', 'Aug 2023', 'Sep 2023', 'Oct 2023', 'Nov 2023', 'Dec 2023', 'Jan 2024'],
                    datasets: [{
                        label: 'Income',
                        data: [85000, 92000, 78000, 94000, 88000, 96000, 94250],
                        backgroundColor: '#10B981',
                        borderRadius: 4,
                        borderSkipped: false,
                    }, {
                        label: 'Expenses',
                        data: [32000, 35000, 29000, 38000, 33000, 31000, 31200],
                        backgroundColor: '#64748B',
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 11,
                                    family: 'Inter'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#F1F5F9'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'R' + (value/1000) + 'k';
                                },
                                font: {
                                    size: 11,
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                }
            });

            // Pie Chart
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            window.pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Net Income', 'Expenses'],
                    datasets: [{
                        data: [63050, 31200],
                        backgroundColor: ['#10B981', '#64748B'],
                        borderWidth: 0,
                        cutout: '65%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12,
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9672b219b7350714',t:'MTc1Mzg1NTg1NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
